<!DOCTYPE html>
<html class="page" lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="src/img/manifest/icons/logo.svg" sizes="12x12" type="image/x-svg">
    <link rel="stylesheet" href="src/styles/style.min.css">
    <title>Conectt</title>
</head>
<body class="page__body">
<header class="header">
    <div class="header__inner">
        <a href="#" class="header__logo">conectt</a>
        <nav class="header__nav">
            <ul class="header__list ulres">
                <li class="header__item"><a href="#" class="header__link">О нас</a></li>
                <li class="header__item"><a href="#" class="header__link">Новости</a></li>
                <li class="header__item"><a href="#" class="header__link">Помощь</a></li>
                <li class="header__item"><a href="#" class="header__link">Блог</a></li>
                <li class="header__item"><a href="#" class="header__link">Сотрудничество</a></li>
            </ul>
        </nav>
    </div>
    <div class="header__user">
        <a download="" href="" class="header__download" title="Скачать">Скачать</a>
        <a href="login.html" class="header__profile">Log in / Register</a>
    </div>
</header>
<main class="main">
    <section class="preview">
        <div class="preview__text">
            <h1 class="preview__title">Программирование в общении. Просто. Удобно.</h1>
            <div class="preview__buttons web-block">
                <div id="form" class="web__form--hidden">

                    <div class="web__container">
                        <input class="web__input" type="text" placeholder="Введите ваш email">
                      <div class="web__input--password">
                        <input id="password" class="web__input" type="password" placeholder="Введите пароль">
                        <img src="src/img/manifest/icons/hide-password.svg" class="web__eye">
                      </div>
                    </div>

                    <a class="web__link">Вперед!</a>
                </div>
                <a class="preview__about">Веб-версия</a>
                <a download="" href="" class="preview__download" title="Скачать">Скачать</a>
            </div>
        </div>
        <img src="src/img/manifest/index/illustration.png" alt="illustration" class="preview__img">
    </section>

    <section class="statistic">
        <ul class="statistic__list ulres">
            <li class="statistic__item">
                <span class="statistic__number">1200</span>
                <p class="statistic__text">Пользователей</p>
            </li>
            <li class="statistic__point"></li>
            <li class="statistic__item">
                <span class="statistic__number">96%</span>
                <p class="statistic__text">Довольны нами</p>
            </li>
            <li class="statistic__point"></li>
            <li class="statistic__item">
                <span class="statistic__number">4</span>
                <p class="statistic__text">В команде</p>
            </li>
        </ul>
    </section>

    <section class="peculiarities">
        <div class="peculiarities__top">
            <div class="peculiarities__text">
                <p class="peculiarities__abovetitle">Особенности</p>
                <h2 class="peculiarities__title">Conectt</h2>
            </div>
            <a download="" href="" class="peculiarities__download" title="Скачать">Начать пользоваться</a>
        </div>
        <ul class="peculiarities__list ulres">
            <li class="peculiarities__item">
                <img src="src/img/manifest/index/ide.png" alt="ide" class="peculiarities__img">
                <h3 class="peculiarities__subtitle">IDE</h3>
                <p class="peculiarities__subtext"> Теперь вам не нужно скачивать дополнительные IDE, оставьте это
                    нам.</p>
            </li>
            <li class="peculiarities__item">
                <img src="src/img/manifest/index/cod.png" alt="cod" class="peculiarities__img">
                <h3 class="peculiarities__subtitle">Код</h3>
                <p class="peculiarities__subtext">Любой может посмотреть исходный код проектов. Стоит только
                    попросить.</p>
            </li>
            <li class="peculiarities__item">
                <img src="src/img/manifest/index/reward.png" alt="reward" class="peculiarities__img">
                <h3 class="peculiarities__subtitle">Награды</h3>
                <p class="peculiarities__subtext">Работайте активно и будете получать награды от сообщества или других
                    пользователей.</p>
            </li>
        </ul>
    </section>

    <section class="subscribe">
        <div class="subscribe__block">
            <h2 class="subscribe__title">Подписывайтесь и будьте с нами!</h2>
            <form class="subscribe__form" action="https://echo.htmlacademy.ru/">
                <label for="email">
                    <input type="email" class="subscribe__input" placeholder="Your email" id="email" required
                           name="email">
                </label>
                <button class="subscribe__button">Subscribe</button>
            </form>
        </div>
    </section>
</main>
<footer class="footer">
    <div class="footer__inner">
        <div class="footer__doc">
            <ul class="footer__list ulres">
                <li class="footer__item"><a href="#" class="footer__linkdoc">работа в компании</a></li>
                <li class="footer__item"><a href="#" class="footer__linkdoc">условия пользования</a></li>
                <li class="footer__item"><a href="#" class="footer__linkdoc">выходные данные</a></li>
                <li class="footer__item"><a href="#" class="footer__linkdoc">политика конфиденциальности</a></li>
            </ul>
        </div>
        <div class="footer__links">
            <a href="#" class="footer__logo">conectt</a>
            <ul class="connection__links ulres">
                <li class="connection__item"><a href="#" class="connection__link"></a></li>
                <li class="connection__item"><a href="#" class="connection__link connection__link--git"></a></li>
                <li class="connection__item"><a href="#" class="connection__link connection__link--inst"></a></li>
            </ul>
            <div class="connection__tel">
                <p class="tel__subtitle">Телефон горячей линии</p>
                <a href="tel:+7 777 777 77" class="tel__phone">+7 777 777 77</a>
            </div>
        </div>
    </div>
</footer>
<script src="src/plugins/axios.js"></script>
<script src="src/pagesLogic/scripts.min.js"></script>
<script>
    let boolean = true
    let editor;
    let lastFile;
    function printIde(server) {
        document.querySelector('.messenger-nav-2__friends').innerHTML = ''
        server.channels.forEach(channel=>{
            let li = document.createElement('li')
            li.classList.add('messenger-nav-2__channel')
            li.classList.add(`messenger-nav-2__channel-${channel.type}`)
            let a = document.createElement('a')
            a.href = '#'
            a.innerText = `#${channel.name}`
            a.addEventListener('click',()=>{
                printChannel(channel)
            })
            li.appendChild(a)
            document.querySelector('.messenger-nav-2__channels-list').appendChild(li)
        })
        let html = '<div class="messenger-main__header">' +
            '<div class="messenger-main__file-name">index.html</div>'
        html += '<div class="messenger-main__container">'
        html += '<button class="messenger-main__start-button">START</button>' +
            '<button class="messenger-main__other"></button>'
        html += '</div></div><textarea id="code" class="codemirror"></textarea>'
        html += '<div class="messenger-main__html"></div>'
        document.querySelector('.messenger-main').innerHTML = html;
        document.querySelector('.messenger-main__header').style.background = '#202627'
        document.querySelector('.messenger-user').classList = 'messenger-files'
        html = '<div class="messenger-files__header"><div class="messenger-files__title">' +
            'Files</div><div class="messenger-files__nav">' +
            '<img src="src/img/manifest/icons/files-add.svg" alt="" class="messenger-files__img messenger-files_create-file">' +
            '<img src="src/img/manifest/icons/folder-add.svg" alt="" class="messenger-files__img messenger-files_create-directory">' +
            '<img src="src/img/manifest/icons/unloading.svg" alt="" class="messenger-files__img messenger-files_upload-file">' +
            '</div></div>'
        html += '<div class="messenger-files__files">' +
            `<ul class="messenger-files__list"></ul></div>`
        document.querySelector('.messenger-files').innerHTML = html;
        document.querySelector('.messenger-main__start-button').addEventListener('click', () => {
            startFile(lastFile)
        })
        editor = CodeMirror.fromTextArea(document.getElementById("code"), {
                mode: "text/html",
                theme: 'material-ocean',
                lineNumbers: true,
                extraKeys: {
                    'Tab': 'emmetExpandAbbreviation',
                    'Esc': 'emmetResetAbbreviation',
                    'Enter': 'emmetInsertLineBreak',
                    'Ctrl-Space': 'emmetCaptureAbbreviation'
                },
                emmet: {
                    mark: true,
                    markTagPairs: true,
                    previewOpenTag: true,
                    config: {
                        // Specify snippets for all markup syntaxes: HTML, XML, Pug etc.
                        markup: {
                            // Shorthand for larger abbreviation
                            foo: 'div.foo>section.bar*3',

                            // Define shape of element, looks like recursive abbreviation
                            a: 'a[href title]',
                            br: 'br/'
                        },

                        // Specify snippets for specific syntax only
                        html: {
                            nav: 'ul.nav>.nav-item*4>a'
                        }
                    }
                }
            }
        );
        printChannel(server.channels[0])
        let keys = []
        window.addEventListener('keydown',e=>{
            if(e.which === 17){
                keys.push(e.which)
            }
            if(e.which == 83&&keys.indexOf(17) !== -1){
                e.preventDefault()
                myAxios.put(`/channels/updateFile`, {...lastFile,data:editor.getValue()})
            }
        })
        window.addEventListener('keyup',e=>{
            keys.splice(keys.indexOf(e.which),1)
        })
    }
    function startFile(file){
        let iframe = document.createElement('iframe')
        iframe.classList.add('code-frame')
        let x = 0
        let i = 0;
        let html = editor.getValue()
        while(x !== -1){
            x = html.indexOf('src',i)
            if(x !== -1){
                let startOfSrc = editor.getValue().indexOf('"',x)
                let endOfSrc = editor.getValue().indexOf('"',startOfSrc + 1)
                const path = `${lastFile.directory.path}/${editor.getValue().substring(startOfSrc + 1,endOfSrc)}`
                const substr = new RegExp(`${editor.getValue().substring(startOfSrc + 1,endOfSrc)}`)
                html = editor.getValue().replace(substr,`${API_URL}/channels/getFileDataByPath${path.split('/')}`)
            }
            i = x + 1
        }
        iframe.setAttribute('srcdoc',html)
        document.querySelector('.messenger-main__html').appendChild(iframe)

    }
    function changeSrc(string){
        let nodes = document.querySelector('.code-frame').contentDocument.querySelectorAll(string)
        nodes.forEach(async node=>{
            if(node.src.indexOf('http') !== -1){
                const path = `${lastFile.directory.path}/${node.getAttribute('src')}`
                node.src = `${API_URL}/channels/getFileDataByPath/${path.split('/')}`
                console.log(node.src)
            }
        })
    }
    function printChannel(channel){
        localStorage.setItem('directory',`/${channel.name}`)
        document.querySelector('.messenger-files_create-file').addEventListener('click',()=>{
            let promptAnswer = prompt('Введите название и расширение файла. Пример: script.js')
            let fileName = promptAnswer.split('.')[0]
            let fileExt = promptAnswer.split('.')[1]
            channel.directories.find(directory=>{if(directory.path.indexOf(localStorage.directory,0))return true})
            myAxios.post('/channels/createFile',{
                channelId:channel.id,
                name:fileName,
                ext:fileExt,
                path:localStorage.directory
            }).then(response=>{
                createFileHTML(response.data)
                me.servers.find(server=>server.id === channel.server.id).channels.find(myChannel => myChannel.id === channel.id).directories.find(directory=>{if(directory.path.indexOf(localStorage.directory,0))return true}).files.push(response.data)
            })
        })
        if(channel.directories.length === 1){
            document.querySelector('.messenger-main__file-name').innerText = 'File'
            document.querySelector('.messenger-files__list').innerHTML = ''
        }
        channel.directories.forEach(directory=>{
            if(directory.name === channel.name){
                directory.files.forEach(file=>{
                    createFileHTML(file)
                })
                printFile(directory.files[2])
            }
        })
    }
    function createFileHTML(file){
        let li = document.createElement('li')
        li.classList.add(`messenger-files__list-item`)
        let img = document.createElement('img')
        img.src = 'src/img/manifest/icons/file.svg'
        li.appendChild(img)
        li.insertAdjacentHTML('beforeend',`${file.name}.${file.ext}`)
        li.addEventListener('click',()=>{
            printFile(file)
        })
        document.querySelector('.messenger-files__list').appendChild(li)
    }
    async function printFile(file){
        lastFile = file
        let data = await myAxios.get(`channels/getFileData${file.id}`)
        editor.getDoc().setValue(data.data);
        document.querySelector('.messenger-main__file-name').innerText = `${file.name}.${file.ext}`
    }
</script>
</body>
</html>
